module.exports=function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=15)}([function(e,t){e.exports=require("bluebird")},function(e,t){e.exports=require("lodash")},function(e,t,n){"use strict";(function(){var t=n(8),r={init:function(e){return e._jsonit={_meta:{id:t(),commits:[],pulls:{}},users:{},groups:{}},e},isInitialized:function(e){return void 0!==e._jsonit},getId:function(e){return e._jsonit._meta.id},setId:function(e,t){e._jsonit._meta.id=t},getCommits:function(e){return e._jsonit._meta.commits},getPulls:function(e){return e._jsonit._meta.pulls},setPulls:function(e,t){e._jsonit._meta.pulls=t},getUsers:function(e){return e._jsonit.users},getGroups:function(e){return e._jsonit.groups},getListeners:function(e){return e._jsonit.listeners},setListeners:function(e,t){e._jsonit.listeners=t},setMeta:function(e,t){return e._jsonit._meta=t,e},removeMeta:function(e){var t=e._jsonit._meta;return delete e._jsonit._meta,t},resetMeta:function(e){delete e._jsonit._meta.commits,delete e._jsonit._meta.pulls}};r.ID_PATH="_jsonit._meta.id",r.META_PATH="_jsonit",r.JSONIT_USERS="_jsonit.users.",r.JSONIT_GROUPS="_jsonit.groups.",r.JSONIT_USER="_jsonit.users",r.JSONIT_GROUP="_jsonit.groups",r.JSONIT_COMMITS="_jsonit._meta.commits",r.JSONIT_PULLS="_jsonit._meta.pulls",r.READ="read",r.WRTIE="write",e.exports=r}).call(void 0)},function(e,t,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};(function(){var t=n(1),i=function(e,t){this.root=this.compare(e,t),null===this.root&&(this.root={})};i.prototype.didChange=function(){return 0!==Object.keys(this.root).length},i.prototype.compare=function(e,t){return Array.isArray(e)&&Array.isArray(t)?this.compareArrays(e,t):this.compareObjects(e,t)},i.prototype.compareArrays=function(e,t,n){for(var o=0,s=0,u=[];o<e.length||s<t.length;){var c=null,a=null,l=null,h=null,f=null;if(o<e.length&&(c=r(e[o]),a=e[o]),s<t.length&&(l=r(t[s]),h=t[s]),null===(f=null===a||null===h||this.compareFields(c,a,l,h,o)))o++,s++;else{for(var p=0;p+s<t.length;){p++;var d=r(t[s+p]),m=t[s+p];if(null===this.compareFields(c,a,d,m,o+p))break}p=0===p?e.length+t.length+1:p;for(var y=0;y+o<e.length;){y++;var g=r(e[o+y]),v=e[o+y];if(null===this.compareFields(g,v,l,h,o+y))break}y=0===y?e.length+t.length+1:y;for(var S=0,b=[];S+o<e.length&&S+s<t.length;){S++,b.push(f);var v=e[o+S],m=t[s+S];if(null===(f=this.compare(v,m)))break}if(S=0===S?e.length+t.length+1:S,p<=y&&p<=S){for(var T=0;T<p;T++)u.push(new i.Change(s+T,t[s+T],i.Change.Add));s+=p}else if(y<=p&&y<=S){for(var T=0;T<y;T++)u.push(new i.Change(s,null,i.Change.Delete));o+=y}else{for(var T=0;T<S;T++)u.push(new i.Change(s+T,b[T],i.Change.Modify));o+=S,s+=S}}}return 0===u.length&&(u=null),u},i.prototype.compareObjects=function(e,n){var o=this,s={},u=t.keys(e),c=t.keys(n);if(0===u.length&&0===c.length){var a=void 0===e?"undefined":r(e),l=void 0===n?"undefined":r(n),h=e,f=n;s=o.compareFields(a,h,l,f,null)}else{var p=t.difference(c,u);t.forEach(p,function(e){s[e]=new i.Change(e,n[e],i.Change.Add)});var d=t.difference(u,c);t.forEach(d,function(e){s[e]=new i.Change(e,null,i.Change.Delete)});var m=t.intersection(u,c);t.forEach(m,function(t){var i=r(e[t]),u=r(n[t]),c=e[t],a=n[t],l=o.compareFields(i,c,u,a,t);null!==l&&(s[t]=l)}),0===t.keys(s).length&&(s=null)}return s},i.prototype.compareFields=function(e,n,o,s,u){var c=null;return s instanceof Date&&(s=s.toJSON(),o=void 0===s?"undefined":r(s)),n instanceof Date&&(n=n.toJSON(),e=void 0===n?"undefined":r(n)),e!==o?c=new i.Change(u,s,i.Change.Modify):"object"!==e?n!==s&&(c=new i.Change(u,s,i.Change.Modify)):0===t.keys(n).length||0===t.keys(s).length?n===s||"object"===e&&"object"===o&&null!==n&&null!==s&&t.keys(n).length===t.keys(s).length||(c=new i.Change(u,s,i.Change.Modify)):c=this.compare(n,s),c},i.Change=function(e,t,n){this.field=e,this.value=t,this.type=n,this.__Diff=!0},i.Change.Add=0,i.Change.Modify=1,i.Change.Delete=2,e.exports=i}).call(void 0)},function(e,t,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};(function(){var t=n(1),i=n(10),o=n(3),s={merge:function(e,n){return n=JSON.parse(JSON.stringify(n)),t.forEach(n,function(t){e=s._mergeSingle(e,t.root)}),e},_mergeSingle:function(e,t){return e=Array.isArray(e)?s._mergeSingleArray(e,t):"object"===(void 0===e?"undefined":r(e))?s._mergeSingleObject(e,t):s._mergeSingleItem(e,t,null)},_mergeSingleObject:function(e,n){var r=t.keys(n);return t.forEach(r,function(t){var r=s._mergeSingleItem(e,n[t],t);n[t].type!==o.Change.Delete&&(e[t]=r)}),e},_mergeSingleArray:function(e,t){for(var n=0;n<t.length;n++){var u=t[n];o.Change.Add===u.type?e.splice(u.field,0,i.convert(u.value)):o.Change.Delete===u.type?e.splice(u.field,1):"object"===r(u.value)?e[u.field]=s._mergeSingle(e[u.field],u.value):e[u.field]=i.convert(u.value)}return e},_mergeSingleItem:function(e,t,n){var r=null;return o.Change.Add===t.type||o.Change.Modify===t.type?r=i.convert(t.value):o.Change.Delete===t.type?delete e[n]:r=null!==n?s._mergeSingle(e[n],t):i.convert(t.value),r}};e.exports=s}).call(void 0)},function(e,t,n){"use strict";(function(){var t=n(1),r=function(){};r.prototype.checkAccess=function(e,t,n,i,o,s){var u=!!t[r.DEFAULT]&&t[r.DEFAULT][s],c=i.replace(/\./g,"-");if(e===i)u=!0;else if(void 0!==t[c]&&t[c][s])u=!0;else for(var a=0;a<o.length;a++){var l=o[a].replace(/\./g,"-");if(void 0!==n[l]&&n[l][s]){u=!0;break}}return u},r.prototype.assignUserToObject=function(e,t,n,i){var o=t.replace(/\./g,"-"),s=new r.Entry(n,i);return e[o]=s,e},r.prototype.assignGroupToObject=function(e,t,n,i){var o=t.replace(/\./g,"-"),s=new r.Entry(n,i);return e[o]=s,e},r.prototype.addUserToGroup=function(e,n,r){return t.indexOf(n,r)<0&&n.push(r),n},r.Entry=function(e,t){this.read=e,this.write=t},r.READ_ACCESS="read",r.WRITE_ACCESS="write",r.DEFAULT="default",e.exports=r}).call(void 0)},function(e,t,n){"use strict";(function(){var t=n(0),r=function(e,t){this.user=e,this.db=t};r.prototype.setup=function(){var e=this,n=this.db.getCollection(this.user+"_Branches",this.user+"_Branches");return this.db.promisified||(n=t.resolve(n)),n.then(function(t){return null===t?e.db.addCollection(e.user+"_Branches",e.user+"_Branches"):t})},r.prototype.drop=function(){var e=this;return this.list().then(function(n){if(null===n)return null;for(var r=new Array(n.length),i=0;i<n.length;i++)r[i]=e.delete(n[i]);return t.all(r)}).then(function(t){if(null!==t)return e.db.removeCollection(e.user+"_Branches")})},r.prototype.checkout=function(e){var n=this.db.getCollection(e,this.user+"_Branch_"+e);return this.db.promisified||(n=t.resolve(n)),n},r.prototype.getMetaInfo=function(e,n){var r=this.db.getCollection(this.user+"_Branches",this.user+"_Branches");return this.db.promisified||(r=t.resolve(r)),r.then(function(t){return t.findOne({name:e},n)})},r.prototype.updateMetaInfo=function(e,n){var r=null,i=this.db.getCollection(this.user+"_Branches",this.user+"_Branches");return this.db.promisified||(i=t.resolve(i)),i.then(function(t){return r=t,r.findOne({name:e})}).then(function(t){return t.users=n.users,t.groups=n.groups,r.update({name:e},t)})},r.prototype.searchBranch=function(e){var n=this.db.getCollection(e,this.user+"_BranchSearch_"+e,!0);return this.db.promisified||(n=t.resolve(n)),n},r.prototype.add=function(e,t,n,i){var o=this,s=null;return this.checkout(e).then(function(t){return s=t,null===s?(o.db.addCollection(e,o.user+"_BranchSearch_"+e,!0),o.db.addCollection(e,o.user+"_Branch_"+e)):null}).then(function(e){return null!=e?(s=e,o.db.getCollection(o.user+"_Branches",o.user+"_Branches")):e}).then(function(o){if(null!=o){var u=new r.Branch(e,t,n,i);o.insert(u,{name:e})}return s})},r.prototype.delete=function(e){var n=this;return t.all([this.checkout(e),this.searchBranch(e),this.db.getCollection(n.user+"_Branches",this.user+"_Branches")]).spread(function(r,i,o){var s=[o.remove({name:e})];return r&&s.push(n.db.removeCollection(n.user+"_Branch_"+e)),i&&s.push(n.db.removeCollection(n.user+"_BranchSearch_"+e)),t.all(s)})},r.prototype.list=function(){var e=this.db.getCollection(this.user+"_Branches",this.user+"_Branches");return this.db.promisified||(e=t.resolve(e)),e.then(function(e){if(null==e)return null;var t={map:function(e,t,n){return{key:e.name,params:{},value:e.name}},reduce:function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].value);return t}};return e.search({},null,t,{name:1})})},r.Branch=function(e,t,n,r){this.name=e,this.users=null==t?{}:t,this.groups=null==n?{}:n,this.listeners=null==r?[]:r},e.exports=r}).call(void 0)},function(e,t,n){"use strict";(function(){var t=(n(1),n(8)),r=function(e){this.commits=void 0===e?[]:e};r.prototype.addCommit=function(e,t,n,i,o){this.commits.push(new r.Commit(e,t,n,i,o)),this.commits[0].isFirst=!0},r.prototype.prefixCommit=function(e,t,n,i,o){this.commits.unshift(new r.Commit(e,t,n,i,o)),this.commits[0].isFirst=!0,null!=this.commits[1]&&delete this.commits[1].isFirst},r.prototype.remove=function(e){return this.commits.splice(0,e)},r.prototype.getAllCommits=function(){return this.commits},r.prototype.getNoOfCommits=function(){return this.commits.length},r.prototype.getFilteredCommits=function(e,t){var n=[];for(var r=0;r<this.commits.length;r++){var i=this.commits[r];if(e!==i.commitId){if(n.push(i),t===i.commitId)break}else!0,n=[]}return n},r.Commit=function(e,n,r,i,o){this.diff=e,this.logMessage=n,this.dateAndTime=r,this.userId=i,this.commitId=void 0===o?t():o},e.exports=r}).call(void 0)},function(e,t){e.exports=require("uuid/v4")},function(e,t){e.exports=require("socket.io-client")},function(e,t,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};(function(){var t=n(1),i={dateRegex:/^(19|20)[0-9]{2}-[0-1]{1}[0-9]{1}-[0-3]{1}[0-9]{1}T[0-2]{1}[0-9]{1}:[0-5]{1}[0-9]{1}:[0-5]{1}[0-9]{1}\.[0-9]{3}Z$/,convert:function(e){if(Array.isArray(e))e=i._convertArray(e);else if("object"===(void 0===e?"undefined":r(e)))e=i._convertObject(e);else if("string"==typeof e&&e.match(i.dateRegex))try{e=new Date(e)}catch(e){}return e},_convertObject:function(e){if(e instanceof Date)return e;for(var n=t.keys(e),r=0;r<n.length;r++){var o=n[r];e[o]=i.convert(e[o])}return e},_convertArray:function(e){for(var t=0;t<e.length;t++)e[t]=i.convert(e[t]);return e}};e.exports=i}).call(void 0)},function(e,t){e.exports=require("moment")},function(e,t,n){"use strict";(function(){var t=function(e){this.pulls=void 0===e?{}:e};t.prototype.updatePull=function(e,t,n){void 0===this.pulls[e]&&(this.pulls[e]={}),this.pulls[e].head=t,this.pulls[e].doc=n},t.prototype.getPullInformation=function(e){return void 0===this.pulls[e]&&(this.pulls[e]={}),this.pulls[e]},e.exports=t}).call(void 0)},function(e,t,n){"use strict";(function(){var t=(n(1),n(0)),r=n(6),i=n(7),o=n(3),s=n(2),u=n(4),c=n(12),a=function(e,t,n,i,o){this.debug=null!=o&&o,this.user=e,this.db=t,this.notifications=n,this.MapReduce=i,this.branches=new r(this.user,this.db)};a.prototype.setup=function(){return this.branches.setup()},a.prototype.drop=function(){return this.branches.drop()},a.prototype.get=function(e,n){var r={};r[s.ID_PATH]=n;var i=e.findOne(r);return this.db.promisified||(i=t.resolve(i)),i.then(function(e){return null===e&&(e=s.init({}),s.setId(e,n)),e})},a.prototype.search=function(e,n,r,i,o,s,u){var c=null,a=null;null!=r&&null!=r.reduce&&(c=new this.MapReduce(r,this.debug)),null!=r&&null!=r.map&&(a=r.map.values);var l=e.search(n,a,c,i,o,s);return this.db.promisified||!0===u||(l=t.resolve(l)),l},a.prototype.commit=function(e,n,r,c,l){var h=null,f=!1,p=null,d=this,m=null,y=JSON.parse(JSON.stringify(n));if(delete y._id,s.isInitialized(y)){var g={};g[s.ID_PATH]=s.getId(y),h=e.findOne(g),d.db.promisified||(h=t.resolve(h))}else s.init(y),h=t.resolve(null);return h=h.then(function(t){var n=!1;null===t&&(t={}),s.isInitialized(t)||(n=!0,s.init(t),s.setId(t,s.getId(y))),m=JSON.parse(JSON.stringify(t));var h=null,g=s.removeMeta(m),v=JSON.parse(JSON.stringify(g));s.removeMeta(y);var S=new o(m,y);if(S.didChange()||null!=l){y=u.merge(t,[S]),s.setMeta(y,g),p=new i(s.getCommits(y)),p.addCommit(JSON.parse(JSON.stringify(S)),r,new Date,c,l);var b=p.getNoOfCommits();p.getNoOfCommits()>a.MAX_COMMITS&&d.truncateCommits(p,a.TRUNCATE_COMMITS,c);var T={};T[s.ID_PATH]=s.getId(y),h=e.findAndMerge(T,y,[S],s.getCommits(y),n,b),f=!0}else h=t;return s.setMeta(m,v),h}),h.then(function(t){if(!0===f&&void 0!==d.notifications&&null!==d.notifications){var n=p.getAllCommits();d.notifications.notify(d.user,e.getName(),s.getId(t),t,n[n.length-1],m,d.branches,e.isSearchBranch())}return t}),h},a.prototype.mergeToBranch=function(e,n,r,i,o,u,a){var l=this;return this.get(e,n).then(function(h){var f=h,p=null,d=null;if(0===r.length)return f;p=new c(s.getPulls(f)),void 0!==a&&(d=p.getPullInformation(a),null==u&&null!==d&&(u=d.head));var m=l.getMergeReport(f,r,u);if(0!==m.conflicts.length)throw new Error("Merge Conflict");null===d||void 0===d.doc||r[0].isFirst?null==u||null==h||r[0].isFirst?(f=s.init({}),s.setId(f,n),s.setPulls(f,p.pulls)):f=h:f=d.doc;var y,g,v;return m.discardedCommits.length>0&&(v=l.mergeCommitsToDocument(f,m.discardedCommits,""),f=v.doc),m.theirCommits.length>0?(v=l.mergeCommitsToDocument(f,m.theirCommits,i),y=v.commitId,g=l.commit(e,v.doc,v.message,o,v.commitId)):(y=r[r.length-1].commitId,g=t.resolve(f)),void 0!==a&&(g=g.then(function(t){return l.updatePullHead(e,t,a,y)})),m.ourCommits.length>0&&m.theirCommits.length>0&&(g=g.then(function(t){var n=l.mergeCommitsToDocument(t,m.ourCommits,i);return l.commit(e,n.doc,n.message,o,n.commitId)})),g})},a.prototype.confirmMergeToBranch=function(e,t,n,r){var i=this;return this.get(e,t).then(function(t){return null!==t&&i.updatePullHead(e,t,r,n[n.length-1].commitId),t})},a.prototype.updatePullHead=function(e,t,n,r){var i=new c(s.getPulls(t)),u=JSON.parse(JSON.stringify(t));s.resetMeta(u);var a=JSON.parse(JSON.stringify(t));i.updatePull(n,r,u);var l={};l[s.ID_PATH]=s.getId(t);var h=new o(a,t);return e.update(l,t,[h])},a.prototype.getMergeReport=function(e,t,n){for(var r=s.getCommits(e),o=new i(r),u=new i(t),c=[],l=!1,h=void 0,f=r.length-1;f>=0&&!l;f--){h=r[f],h.commitId===n&&(l=!0);for(var p=t.length-1;p>=0&&!l;p--){t[p].commitId===h.commitId&&(l=!0)}}return!0===l&&(c=o.getFilteredCommits(null,h.commitId),r=o.getFilteredCommits(h.commitId),t=u.getFilteredCommits(h.commitId)),new a.MergeReport(r,t,c,[])},a.prototype.truncateCommits=function(e,t,n){var r=e.getNoOfCommits()-t,i=e.remove(r),u=s.init({});s.removeMeta(u),u=this.mergeCommitsToDocument(u,i,"").doc;var c=s.init({});s.removeMeta(c);var l=new o(c,u);return e.prefixCommit(l,a.MAX_COMMITS_LOG_MESSAGE,new Date,n,i[i.length-1].commitId),e},a.prototype.mergeCommitsToDocument=function(e,t,n){for(var r="",i=0;i<t.length;i++){var o=t[i];r=o.commitId,e=u.merge(e,[o.diff]),n=n+" "+o.logMessage+" ("+r+")."}return new a.MergedCommit(e,n,r)},a.MergeReport=function(e,t,n,r){this.ourCommits=e,this.theirCommits=t,this.discardedCommits=n,this.conflicts=r},a.MergedCommit=function(e,t,n){this.doc=e,this.message=t,this.commitId=n},a.MAX_COMMITS=100,a.TRUNCATE_COMMITS=80,a.MAX_COMMITS_LOG_MESSAGE="Merged previous commits",e.exports=a}).call(void 0)},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(2),s=n(27),u=n(29),c=function(){function e(t,n){r(this,e),this.debug=null!=n&&n,this.projections=t,this.resultLength=0,this.keysToIndexMapping={},this._compiler=new s}return i(e,[{key:"map",value:function(e,t,n){for(var r={index:this.resultLength,key:"",params:{},value:{}},i=this.projections.map.keys,s=0;s<i.length;s++){var u=i[s];r.key+=e[u],r.params[u]=e[u]}var c="";o.isInitialized(e)&&(c=o.getId(e)),0===i.length&&(r.key=c,r.params.id=c);var a=this.keysToIndexMapping[r.key];return null==a?(this.keysToIndexMapping[r.key]=this.resultLength,this.resultLength++):r.index=a,r.value=e,r.value._id=c,r}},{key:"reduce",value:function(e){for(var t=new Array(this.resultLength),n=this._compiler.compile(this.projections.reduce),r=0;r<e.length;r++){var i=e[r],o=t[i.index];void 0===o&&(o={_params:i.params}),t[i.index]=u.eval(i.value,n,r,e,!1,o)}return t}}]),e}();e.exports=c},function(e,t,n){"use strict";(function(){var t={JitACL:n(5),JitBranches:n(6),JitCommits:n(7),JitDiff:n(3),JitDocument:n(2),JitFileHash:n(16),JitLocalQueue:n(18),JitLokiDb:n(19),JitMathLib:n(22),JitMerge:n(4),JitPulls:n(12),JitRepository:n(13),JitClient:n(23),JitFileManager:n(26),JitMapReduceTemplates:n(14),JitNotifications:n(30),JitPullRequests:n(32),JitSearch:n(33),JitSocketClient:n(34),JitSQS:n(35),JitSync:n(37),JitUserManagement:n(38)};e.exports=t}).call(void 0)},function(e,t,n){"use strict";(function(){var t=n(17).sha3_256,r={};r.hash=function(e){return t(e)},e.exports=r}).call(void 0)},function(e,t){e.exports=require("js-sha3")},function(e,t,n){"use strict";var r=n(9),i=n(0),o=function(e){var t=this;this.url=e,this.pendingRecv={},this.socket=r(this.url),this.socket.on(o.CONNECT,function(){for(var e=Object.keys(t.pendingRecv),n=0;n<e.length;n++){var r=e[n];t.pendingRecv[r]([])}t.pendingRecv={}})};o.prototype.sendMessage=function(e,t,n,r){var s=this;return new i(function(n){s.socket.emit(o.SEND_MESSAGE,{queue:e,messages:t},function(e){n(e)})})},o.prototype.receiveMessage=function(e,t,n,r){var s=this;return new i(function(t){s.pendingRecv[e]=t,s.socket.emit(o.RECEIVE_MESSAGE,{queue:e,max:n},function(n){delete s.pendingRecv[e],t(n)})})},o.prototype.cancelReceive=function(e){this.pendingRecv[e]([])},o.SEND_MESSAGE="send",o.RECEIVE_MESSAGE="receive",o.CONNECT="connect",o.STATUS_DONE=200,e.exports=o},function(e,t,n){"use strict";(function(){var t=n(0),r=n(20),i=n(21),o=function(e,n){if(this.dbname=e,this.options=n,this.database=null,this.promisified=!1,!0===this.options.autoload){var r=null;this.connectionPromise=new t(function(e){r=e}),this.connectionPromiseResolve=r}else this.connectionPromise=t.resolve(!0)};o.prototype.connect=function(){var e=this,t=this.options.autoload;return this.options.autoload=!1,this.database=new r(this.dbname,this.options),!0===t&&this.database.loadDatabase(this.options.inflateLocalDb||{},function(){e.connectionPromiseResolve(!0)}),this.connectionPromise},o.prototype.getCollection=function(e,t,n){var r=this.database.getCollection(t);return null!==r&&(r=new i(e,r,n)),r},o.prototype.addCollection=function(e,t,n){var r=this.database.addCollection(t);return r=new i(e,r,n)},o.prototype.removeCollection=function(e){return this.database.removeCollection(e)},e.exports=o}).call(void 0)},function(e,t){e.exports=require("lokijs")},function(e,t,n){"use strict";(function(){var t=n(1),r=(n(0),n(2)),i=n(4),o=function(e,t,n){this._name=e,this.collection=t,this._isSearch=n,this.type="LokiJs"};o.prototype.search=function(e,t,n,r,i,o){var s=[];if(s.push({type:"find",value:e}),null!=r){for(var u=Object.keys(r),c=new Array(u.length),a=0;a<u.length;a++)c[a]=[u[a],1!==r[u[a]]];s.push({type:"compoundsort",value:c})}null!=n&&s.push({type:"mapReduce",mapFunction:function(e,t,r){return e=JSON.parse(JSON.stringify(e)),n.map(e,t,r)},reduceFunction:function(e){return n.reduce(e)}});var l=this.collection.chain(s);null==n&&(l=JSON.parse(JSON.stringify(l.data())));for(var a=0;a<l.length;a++)delete l[a].meta,delete l[a].$loki;return l},o.prototype.findOne=function(e){var t=this.collection.findOne(e);return null!=t&&(t=JSON.parse(JSON.stringify(t)),delete t.meta,delete t.$loki),t},o.prototype.insert=function(e){var t=this.collection.insert(e);return t=JSON.parse(JSON.stringify(t)),delete t.meta,delete t.$loki,t},o.prototype.update=function(e,n,o,s){var u=[],c=null;return u.push({type:"find",value:e}),u.push({type:"update",value:function(e){if(r.isInitialized(e)&&null!=o){if(e=i.merge(e,o),null!=s){var u=r.getCommits(e);u.push(s[s.length-1])}}else{e=t.assign(e,n);for(var a=t.keys(e),l=t.keys(n),a=t.keys(e),l=t.keys(n),h=t.difference(a,l),f=0;f<h.length;f++){var p=h[f];"$loki"!==p&&"meta"!==p&&"_jsonit"!==p&&delete e[p]}}c=JSON.parse(JSON.stringify(e)),delete c.meta,delete c.$loki}}),this.collection.chain(u),null!=c?c:n},o.prototype.findAndMerge=function(e,t,n,r,i){return i?this.insert(t):this.update(e,t,n,r)},o.prototype.remove=function(e){var t=this.collection.findOne(e);t&&this.collection.remove(t)},o.prototype.getName=function(){return this._name},o.prototype.isSearchBranch=function(){return this._isSearch},e.exports=o}).call(void 0)},function(e,t,n){"use strict";(function(){var t=n(1),r=n(11),i={extend:function(e){var n={merge:function(){for(var e=arguments,t="",n=0;n<e.length;n++)null!=e[n]&&(t+=e[n]);return t},iftrue:function(e,t,n){return e?t:n},ifeq:function(e,t,n,r){return e==t?n:r},ifneq:function(e,t,n,r){return e!=t?n:r},ifgt:function(e,t,n,r){return e>t?n:r},iflt:function(e,t,n,r){return e<t?n:r},sane:function(e){return null==e&&(e=""),e},minDate:function(e,t){var n=r(e),i=r(t);return""!==e&&n.isValid()?""!==t&&i.isValid()?r.min(n,i):n:i},maxDate:function(e,t){var n=r(e),i=r(t);return""!==e&&n.isValid()?""!==t&&i.isValid()?r.max(n,i):n:i},dt:function(e,t){var n;if(null!=t)n=r(e,t).toDate();else try{n=new Date(e)}catch(e){}return n},dtstr:function(e,t){return r(e).format(t)},today:function(){return new Date},arrstr:function(e,t,n){var r=t||"",i=n||"";return e.map(function(e){return r+e+i}).join("")},dtadd:function(e,t,n){var i=r({year:e.year,month:e.month-1,date:e.day,hour:e.hour,minute:e.minute,seconds:e.second});return i.add(t,n),i},sortedIns:function(e,n,r){Array.isArray(e)||(e=[]),null==r&&(r=!1),Array.isArray(n)||(n=[n]);for(var i=0;i<n.length;i++){var o=n[i],s=t.sortedIndex(e,o);(r||e[s]!==o)&&e.splice(s,0,o)}return e},debug:function(){null!=console.groupCollapsed?console.group("MathLib Debug: "+arguments[0]):console.log("MathLib Debug: "+arguments[0]);for(var e=1;e<arguments.length;e++)console.log(arguments[e]);return null!=console.groupEnd&&console.groupEnd(),arguments[1]}},i={override:!1,silent:!0,wrap:!0};e.import(n,i)}};e.exports=i}).call(void 0)},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(0),c=n(24),a=n(25),l=function(){function e(t,n,r,o){i(this,e),this.url=t,this.clientId=n,this.clientSecret=r,this.scopes=o,this.owner=null,this.auth=null,this.connection=null}return s(e,null,[{key:"OAUTH_ENDPOINT",get:function(){return"/oauth/token"}},{key:"API_ENDPOINT",get:function(){return"/api/"}},{key:"HTTP_GET",get:function(){return"GET"}},{key:"HTTP_POST",get:function(){return"POST"}},{key:"HTTP_SEP",get:function(){return"/"}}]),s(e,[{key:"passwordGrant",value:function(t,n){var r=this;return this.auth=new c({clientId:this.clientId,clientSecret:this.clientSecret,accessTokenUri:this.url+e.OAUTH_ENDPOINT,scopes:this.scopes}),this.owner=t.split(e.HTTP_SEP,2)[1],this.auth.owner.getToken(t,n).then(function(e){return r.connection=e,r})}},{key:"clientCredentials",value:function(t,n){var r=this;return this.auth=new c({clientId:t,clientSecret:n,accessTokenUri:this.url+e.OAUTH_ENDPOINT,scopes:this.scopes}),this.owner=this.clientId.split(e.HTTP_SEP,2)[1],this.auth.credentials.getToken().then(function(e){return r.connection=e,r})}},{key:"reconnect",value:function(t,n,r,i){if(null==i&&(i=null!=r),this.auth=new c({clientId:this.clientId,clientSecret:this.clientSecret,accessTokenUri:this.url+e.OAUTH_ENDPOINT,scopes:this.scopes}),this.owner=t.split(e.HTTP_SEP,2)[1],this.connection=this.auth.createToken(n,r,"bearer",{}),0==i)return u.resolve(this);var o=this;return this.connection.refresh().then(function(e){return o.connection=e,o})}},{key:"pull",value:function(t,n,r,i,o,s){var u=this,c=this.connection.sign({method:e.HTTP_GET,url:this.url+e.API_ENDPOINT+t+e.HTTP_SEP+n+e.HTTP_SEP+r,query:{start:o,end:s}});return a.request(c).use(a.plugins.parse("json")).then(function(e){return u.handleError(e),e.body})}},{key:"push",value:function(t,n,i,o,s,u){var c=this,l=this.connection.sign({method:e.HTTP_POST,url:this.url+e.API_ENDPOINT+n+e.HTTP_SEP+i+e.HTTP_SEP+o,headers:r({},"Content-Type","application/json"),body:{branchFrom:t,commits:s,head:u}});return a.request(l).use(a.plugins.parse("json")).then(function(e){return c.handleError(e),s})}},{key:"search",value:function(t,n,r,i,o,s,u,c,l,h,f,p){var d=this,m=this.connection.sign({method:e.HTTP_POST,url:this.url+e.API_ENDPOINT+t+e.HTTP_SEP+n+"/find/"+r,query:{start:h,end:f,refreshTime:o},body:{query:i,projections:s,sort:u,start:c,limit:l,listeners:p}});return a.request(m).use(a.plugins.parse("json")).then(function(e){return d.handleError(e),e.body})}},{key:"createBranch",value:function(t,n,r,i){var o=this,s=this.connection.sign({method:e.HTTP_POST,url:this.url+e.API_ENDPOINT+this.owner+e.HTTP_SEP+t+e.HTTP_SEP,body:{users:n,groups:r,listeners:i}});return a.request(s).use(a.plugins.parse("json")).then(function(e){return o.handleError(e),!0})}},{key:"chunkForFile",value:function(t){var n=this,r=this.connection.sign({method:e.HTTP_POST,url:this.url+e.API_ENDPOINT+this.owner+e.HTTP_SEP+t+e.HTTP_SEP});return a.request(r).use(a.plugins.parse("json")).then(function(e){return n.handleError(e),!0})}},{key:"handleError",value:function(e){if(e.status<200||e.status>=399){var t=null;throw t="object"===o(e.body)?new Error(e.body.error_message):new Error(e.body+"("+e.status+")"),t.status=e.status,t.body=e.body,t}}}]),e}();e.exports=l},function(e,t){e.exports=require("client-oauth2")},function(e,t){e.exports=require("popsicle")},function(e,t,n){"use strict";(function(){var t=(n(0),n(5)),r=n(2),i=function(e,t){this.repo=e,this.fsBranch=t};i.prototype.newFolder=function(e,t){var n=new i.Entry(e,i.TYPE_DIRECTORY,t);return this.repo.commit(this.fsBranch,n,"Folder: "+e,this.repo.user)},i.prototype.newFile=function(e,n,o,s,u,c,a,l,h,f,p){var d=this,m=null!=f?f:n;return this.repo.get(this.fsBranch,m).then(function(f){if(r.getCommits(f).length>0)return f;var y=new i.Entry(e,i.TYPE_FILE,a,n,o,s,u,c,l,h);if(r.init(y),r.setId(y,m),p){var g=r.getUsers(y);(new t).assignUserToObject(g,t.DEFAULT,!0,!1)}return d.repo.commit(d.fsBranch,y,"File: "+e,d.repo.user)})},i.Entry=function(e,t,n,r,o,s,u,c,a,l){if(this.name=e,this.type=t,this.parentId=n,this.lastModifiedTime=s,this.type===i.TYPE_FILE){this.fId=r,this.hash=o,this.size=u,this.ext=c,this.uploadTime=a,this.status=null!=l?l:i.UPLOAD_NOT_STARTED,this.totalChunks=Math.ceil(this.size/i.CHUNK_SIZE),this.chunkStatus=new Array(this.totalChunks);for(var h=0;h<this.chunkStatus.length;h++)this.chunkStatus[h]=!1}},i.TYPE_DIRECTORY="directory",i.TYPE_FILE="file",i.CHUNK_SIZE=65536,i.UPLOAD_NOT_STARTED=0,i.UPLOAD_PROCESSING=1,i.UPLOAD_SENDING=2,i.UPLOAD_COMPLETED=3,e.exports=i}).call(void 0)},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=(n(0),n(28)),u=function(){function e(){r(this,e),this._templateSettings=Object.assign({},s.templateSettings,{strip:!1})}return o(e,[{key:"compile",value:function(e){var t=JSON.parse(JSON.stringify(e));return this.compileField(t)}},{key:"compileField",value:function(e){var t=new RegExp(this._templateSettings.evaluate),n=new RegExp(this._templateSettings.interpolate),r=new RegExp(this._templateSettings.conditional),o=new RegExp(this._templateSettings.iterate);return Array.isArray(e)?e=this.compileArray(e):"object"===(void 0===e?"undefined":i(e))?e=this.compileObject(e):"boolean"!=typeof e&&"number"!=typeof e&&(t.test(e)||n.test(e)||r.test(e)||o.test(e))&&(e=s.template(e,this._templateSettings)),e}},{key:"compileArray",value:function(e){for(var t=0;t<e.length;t++)e[t]=this.compileField(e[t]);return e}},{key:"compileObject",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n];e[r]=this.compileField(e[r])}return e}}]),e}();e.exports=u},function(e,t){e.exports=require("dot")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(11),u=function(){function e(){r(this,e)}return o(e,null,[{key:"eval",value:function(t,n,r,o,u,c){var a="";if(null==n)return a;if(!0!==u&&(u=!1),"function"==typeof n)try{a=n({index:r,current:t,result:c,data:o,length:o.length,moment:s})}catch(e){console.error("%s Exception: %s. Function: \n%s",describe,e.message,n.toString()),console.error({index:r,current:t,result:c,data:o,length:o.length})}else a=Array.isArray(n)?e.transformArray(t,n,r,o,u,c):"object"!==(void 0===n?"undefined":i(n))||n instanceof Date?n:e.transformObject(t,n,r,o,u,c);return a}},{key:"transformArray",value:function(t,n,r,o,s,u){for(var c=[],a=0;a<n.length;a++){var l=e.eval(t,n[a],r,o,s,u);s?Array.isArray(l)?l.length>0&&c.push(l):"object"!==(void 0===l?"undefined":i(l))||l instanceof Date?""!=l&&null!=l&&c.push(l):Object.keys(l).length>0&&c.push(l):c.push(l)}return c}},{key:"transformObject",value:function(t,n,r,o,s,u){for(var c={},a=Object.keys(n),l=0;l<a.length;l++){var h=a[l],f=e.eval(t,n[h],r,o,s,u);s?Array.isArray(f)?f.length>0&&(c[h]=f):"object"!==(void 0===f?"undefined":i(f))||f instanceof Date?""!==f&&null!=f&&(c[h]=f):Object.keys(f).length>0&&(c[h]=f):c[h]=f}return c}}]),e}();e.exports=u},function(e,t,n){"use strict";(function(){var t=n(2),r=(n(0),n(31)),i=function(){this.listeners=new Map};i.prototype.setQueue=function(e){this.queue=e},i.prototype.register=function(e){var t=this.listeners.get(e);if(void 0===t){var n=new r.Subject;t=new i.Entry(e,n),this.listeners.set(e,t)}return t.s},i.prototype.deregister=function(e){var t=this.listeners.get(e);void 0===t||null!=t.s.observers&&0!==t.s.observers.length||this.listeners.delete(e)},i.prototype.notify=function(e,n,r,i,o,s,u,c){var a=this,l=this.listeners.get(r);if(void 0!==l){var h={owner:e,branch:n,objId:r,obj:i,commit:o};l.s.next(h)}if(null!=this.queue){var f;if(null!=s&&t.isInitialized(s)){var p=t.getCommits(s);p.length>0&&(f=p[p.length-1].commitId)}u.getMetaInfo(n,["listeners"]).then(function(t){for(var i=0;null!=t&&null!=t.listeners&&i<t.listeners.length;i++){var s={id:r,owner:e,branch:n,message:o,users:t.listeners[i].users,groups:t.listeners[i].groups,head:f,isSearch:c};a.queue.sendMessage(t.listeners[i].queue,s,0)}return null});for(var d=t.getListeners(i),m=0;null!=d&&m<d.length;m++){var y={id:r,owner:e,branch:n,message:o,users:d[m].users,groups:d[m].groups,head:f,isSearch:c};a.queue.sendMessage(d[m].queue,y,0)}}},i.Entry=function(e,t){this.objId=e,this.s=t},e.exports=i}).call(void 0)},function(e,t){e.exports=require("rxjs/Subject")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(2),s=function e(t,n,i,o,s,c){r(this,e),this.localBranch=t,this.remoteBranch=n,this.remoteObjectId=i,this.reference=o,this.commits=s,this.head=c,this.status=u.STATUS_OPEN},u=function(){function e(t,n){r(this,e),this.repo=t,this.branch=n}return i(e,null,[{key:"STATUS_OPEN",get:function(){return 0}},{key:"STATUS_MERGED",get:function(){return 1}},{key:"STATUS_REJECTED",get:function(){return 2}}]),i(e,[{key:"add",value:function(e,t,n,r,i,u){var c=new s(e,t,n,r,i,u);return o.init(c),this.repo.commit(this.branch,c,"Pull request ("+n+") "+e+" => "+t,this.repo.user)}}]),e}();e.exports=u},function(e,t,n){"use strict";(function(){var t=n(1),r=n(0),i=n(10),o=n(2),s=function(e,t,n){this.repo=e,this.searchBranch=t,this.dataBranch=n};s.prototype.getSearchEntry=function(e,n,u,c,a,l,h,f){var p=this,d=new s.Entry(n,c,a,l,h);o.setId(d,e);var m=void 0;return m=u<=0?r.resolve({}):this.repo.get(this.searchBranch,o.getId(d)),m.then(function(e){return null!==e&&t.assign(d,e),d.expiry=new Date(d.expiry),d.expiry<=new Date?(n=i.convert(JSON.parse(JSON.stringify(n))),p.repo.search(p.dataBranch,n,c,a,l,h,!0)):null}).then(function(e){return null!=e?(d.data=e,d.expiry=new Date((new Date).getTime()+u*s.MILLI_TO_SECS),null!=f&&o.setListeners(d,f),p.repo.commit(p.searchBranch,d,"Updated search results triggerred from getSearchEntry.",p.repo.user)):d})},s.mergeSearchResults=function(e,n){var r=t.differenceBy(n,e,o.getId),i=t.intersectionWith(n,e,function(e,t){var n=!1;if(o.getId(e)===o.getId(t)){var r=o.getCommits(e),i=o.getCommits(t);if(null!=r&&null!=i){var s=r[r.length-1],u=i[i.length-1];new Date(s.dateAndTime)>new Date(u.dateAndTime)&&(n=!0)}}return n}),s=t.differenceBy(e,i,o.getId);return t.concat(r,i,s)},s.mergeSearchResultsForIds=function(e,n,r){function i(e){for(var t="",n=0;n<r.length;n++){t+=e[r[n]]}return t}var o=t.differenceBy(n,e,i),s=t.intersectionWith(n,e,function(e,t){var n=!1;return i(e)===i(t)&&(n=!0),n}),u=t.differenceBy(e,s,i);return t.concat(o,s,u)},s.sortResults=function(e,n){for(var r=Array.isArray(n)?n:Object.keys(n),i=new Array(r.length),o=0;o<r.length;o++){var s=r[o];i[o]=null==n[s]||n[s]>0?"asc":"desc"}return t.orderBy(e,r,i)},s.Entry=function(e,t,n,r,i){this.data=null,this.expiry=new Date,o.init(this)},s.MILLI_TO_SECS=1e3,e.exports=s}).call(void 0)},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(9),s=n(0),u=function(){function e(t){r(this,e),this.url=t,this.state=e.STATE_DISCONNECTED,this.callback=null,this.socket=null,this.promiseOnConnection=null,this.resolveFunctionForConnection=null,this.promiseOnDisconnection=null,this.resolveFunctionForDisconnection=null,this.promiseOnConnection=this.promiseForConnection(),this.promiseOnDisconnection=this.promiseForDisconnection()}return i(e,null,[{key:"STATE_DISCONNECTED",get:function(){return 0}},{key:"STATE_CONNECTED",get:function(){return 1}},{key:"REQUEST_TIMEOUT",get:function(){return 12e4}},{key:"SYNC_HTTP_TIMEOUT",get:function(){return 504}}]),i(e,[{key:"connect",value:function(e,t){var n=this;return this.socket&&this.disconnect(),this.owner=e,this.token=t,this.socket=o(this.url),this.callback=null,this.socket.on("connect",function(){n.promiseOnDisconnection=n.promiseForDisconnection(),n.onConnect()}),this.socket.on("notify commits",function(e,t){e.type=6,n.callback&&n.callback(e)}),this.socket.on("client notifications",function(e,t){e.type=7,n.callback&&n.callback(e)}),this.socket.on("disconnect",function(e){n.promiseOnConnection=n.promiseForConnection(),n.onDisconnect()}),this.socket.on("error",function(e){console.log(ERROR+" (socket-client): ",e),n.promiseOnConnection=n.promiseForConnection(),n.onDisconnect()}),this.promiseOnConnection}},{key:"disconnect",value:function(){this.token=null;var e=this.socket.disconnect(!0);return this.socket.removeAllListeners(),this.socket=null,e}},{key:"promiseForConnection",value:function(){var e=this;return new s(function(t){e.resolveFunctionForConnection=t})}},{key:"promiseForDisconnection",value:function(){var e=this;return new s(function(t){e.resolveFunctionForDisconnection=t})}},{key:"onConnect",value:function(){this.state=e.STATE_CONNECTED,null!==this.resolveFunctionForConnection&&this.resolveFunctionForConnection(this.socket),this.introduce()}},{key:"onDisconnect",value:function(){this.state=e.STATE_DISCONNECTED,null!==this.resolveFunctionForDisconnection&&this.resolveFunctionForDisconnection(null)}},{key:"onData",value:function(e){this.callback=e}},{key:"emitWithTimeout",value:function(t,n){var r=this;return new s(function(i,o){var s=!1;r.socket.emit(t,n,function(e){s||(s=!0,i(e))}),setTimeout(function(){s||(s=!0,i({error:e.SYNC_HTTP_TIMEOUT,error_message:"Request timed out by client after "+e.REQUEST_TIMEOUT+" millseconds."}))},e.REQUEST_TIMEOUT)}).then(function(e){return void 0!==e.error?r.handleError(e):e})}},{key:"introduce",value:function(){var e={header:{token:this.token}};return this.emitWithTimeout("announce arrival",e)}},{key:"pull",value:function(e,t,n,r,i,o){var s={header:{token:this.token},params:{user:e,branch:t,id:n},query:{start:i,end:o}};return this.emitWithTimeout("get document",s)}},{key:"push",value:function(e,t,n,r,i,o){var s={header:{token:this.token},params:{user:t,branch:n,id:r},body:{branchFrom:e,commits:i,head:o}};return null==s.body.head&&delete s.body.head,this.emitWithTimeout("post commits",s).then(function(e){return i})}},{key:"search",value:function(e,t,n,r,i,o,s,u,c,a,l,h){var f={header:{token:this.token},params:{id:n,user:e,branch:t},query:{start:a,end:l,refreshTime:i},body:{query:r,projections:o,sort:s,start:u,limit:c,listeners:h}};return this.emitWithTimeout("search branch",f)}},{key:"createBranch",value:function(e,t,n,r){var i={header:{token:this.token},params:{user:this.owner,branch:e},body:{users:t,groups:n,listeners:r}};return this.emitWithTimeout("create branch",i).then(function(e){return!0})}},{key:"notify",value:function(e,t,n,r){var i={header:{token:this.token},params:{user:this.owner},body:{ref:e,users:n,groups:r,doc:t}};return this.emitWithTimeout("client notifications",i),!0}},{key:"chunkForFile",value:function(e,t,n,r,i){var o={header:{token:this.token},params:{id:e,user:i,branch:r},body:{chunkNumber:t,chunk:n}};return this.emitWithTimeout("post file chunk",o).then(function(e){return!0})}},{key:"mergeChunksForFile",value:function(e,t,n){var r={header:{token:this.token},params:{id:e,user:n,branch:t}};return this.emitWithTimeout("merge file chunk",r)}},{key:"handleError",value:function(e){var t=new Error(e.error_message);throw t.status=e.error,t.body=e.error_message,t}}]),e}();e.exports=u},function(e,t,n){"use strict";var r=n(0),i=n(36),o=function(e){this.sqs=new r.promisifyAll(new i.SQS({accessKeyId:e.accessKeyId,secretAccessKey:e.secretAccessKey,endpoint:o.SQS_ENDPOINT,region:e.region}))};o.prototype.listQueues=function(){return this.sqs.listQueuesAsync()},o.prototype.createQueue=function(e,t,n,r,i,s,u){null!=r&&"number"==typeof r&&(r=r.toString()),null!=s&&"number"==typeof s&&(s=s.toString()),null!=n&&"number"==typeof n&&(n=n.toString()),null!=i&&"number"==typeof i&&(i=i.toString());var c={QueueName:e,Attributes:{}};return null!=r&&(c.Attributes.DelaySeconds=r),null!=n&&(c.Attributes.ReceiveMessageWaitTimeSeconds=n),null!=s&&(c.Attributes.MessageRetentionPeriod=s),null!=i&&(c.Attributes.VisibilityTimeout=i),t&&(c.Attributes.Policy=JSON.stringify(this.queuePolicyForTopic(t,null,e))),!0===u&&(c.QueueName=e+o.FIFO_SUFFIX,c.Attributes.FifoQueue=u.toString()),this.sqs.createQueueAsync(c)},o.prototype.deleteQueue=function(e){return this.sqs.deleteQueueAsync({QueueUrl:e})},o.prototype.sendMessage=function(e,t,n,r){var i={QueueUrl:e};if(!(t instanceof Array))return i.MessageBody=JSON.stringify(t),n&&(i.DelaySeconds=n),r&&(i.MessageGroupId=r),this.sqs.sendMessageAsync(i);i.Entries=[];for(var o=0;o<t.length;o++)i.Entries[o]={Id:o.toString(),MessageBody:JSON.stringify(t[o])},n&&(i.Entries[o].DelaySeconds=n),r&&(i.Entries[o].MessageGroupId=r);return t.length>0?this.sqs.sendMessageBatchAsync(i):void 0},o.prototype.receiveMessage=function(e,t,n,r){r=null!=r?r:"All";var i={QueueUrl:e,AttributeNames:[r]};null!=t&&(i.WaitTimeSeconds=t),null!=n&&(i.MaxNumberOfMessages=3);var o=[];return this.sqs.receiveMessageAsync(i).then(function(e){if(null==e.Messages)return o;for(var t=0;t<e.Messages.length;t++)o[t]=JSON.parse(e.Messages[t].Body);return o}).catch(function(e){return o})},o.prototype.deleteMessage=function(e,t){if(!(t instanceof Array))return this.sqs.deleteMessageAsync({QueueUrl:e,ReceiptHandle:t});for(var n={QueueUrl:e,Entries:[]},r=0;r<t.length;r++)n.Entries[r]={Id:r.toString(),ReceiptHandle:t[r]};return t.length>0?this.sqs.deleteMessageBatchAsync(n):void 0},o.prototype.purgeQueue=function(e){return this.sqs.purgeQueue({QueueUrl:e}).promise()},o.prototype.setTopic=function(e,t){var n=this;return this.getQueueAttributes(e).then(function(r){return n.sqs.setQueueAttributesAsync({QueueUrl:e,Attributes:{Policy:JSON.stringify(n.queuePolicyForTopic(t,r.Attributes.QueueArn))}})})},o.prototype.setDelay=function(e,t){return null!=t&&"number"==typeof t&&(t=t.toString()),this.sqs.setQueueAttributesAsync({QueueUrl:e,Attributes:{DelaySeconds:t}})},o.prototype.setMessageRetentionPeriod=function(e,t){return null!=t&&"number"==typeof t&&(t=t.toString()),this.sqs.setQueueAttributesAsync({QueueUrl:e,Attributes:{MessageRetentionPeriod:t}})},o.prototype.getQueueAttributes=function(e,t){return t=null!=t?t:"All",this.sqs.getQueueAttributesAsync({QueueUrl:e,AttributeNames:[t]})},o.prototype.queuePolicyForTopic=function(e,t,n){return{Version:"2012-10-17",Id:"S2A_RIKSOF/SQSDefaultPolicy",Statement:[{Sid:"SQSDefaultPolicy001",Effect:"Allow",Principal:"*",Action:"SQS:*",Resource:null!=t?t:"arn:aws:sqs:us-east-1:421969266154:"+n,Condition:{ArnEquals:{"aws:SourceArn":e}}}]}},o.SQS_ENDPOINT="https://sqs.us-east-1.amazonaws.com",o.FIFO_SUFFIX=".fifo",e.exports=o},function(e,t){e.exports=require("aws-sdk")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(0),s=n(2),u=function e(t,n,i){r(this,e),this.type=t,this.args=n,this.ref=i},c=function(){function e(t,n,i,o,s){r(this,e),this.client=t,this.repo=n,this.branch=i,this.name=o,this.callback=s,this.pendingSync=0,this.totalSync=0,this.syncPromise=null,this.highPriority=[],this.normalPriority=[],this.lowPriority=[],this._setup=this.setupNotifications()}return i(e,null,[{key:"PULL_ENTRY",get:function(){return 0}},{key:"PUSH_ENTRY",get:function(){return 1}},{key:"SEARCH_ENTRY",get:function(){return 2}},{key:"CREATE_BRANCH",get:function(){return 3}},{key:"POST_FILE_CHUNK",get:function(){return 4}},{key:"MERGE_FILE_CHUNK",get:function(){return 5}},{key:"NOTIFY_DATA",get:function(){return 6}},{key:"SEND_NOTIFICATION",get:function(){return 7}}]),i(e,[{key:"setupNotifications",value:function(){var e=this;return this.client.promiseOnConnection.then(function(){return e.client.onData(function(t){return 6===t.type?e.callback(null,t.message,{type:t.type,args:[t.owner,t.branch,t.id,t.head,t.isSearch]}):7===t.type?e.callback(null,t.message,{type:t.type,args:[t.owner]}):void 0}),e.client.promiseOnDisconnection}).then(function(){return e.setupNotifications(),null})}},{key:"add",value:function(e,t,n,r){var i=new u(e,t,n);i=JSON.parse(JSON.stringify(i));for(var o=!1,s=0;!o&&s<r.length;s++)r[s].ref===n&&(o=!0,r[s]=i);o||(r.push(i),this.totalSync++,(null===this.syncPromise||this.syncPromise.isFulfilled())&&(this.totalSync=1,this.syncPromise=this.run(this.normalPriority,this.highPriority,this.lowPriority,this.callback)))}},{key:"run",value:function(e,t,n,r){if(this.pendingSync=t.length+e.length+n.length,0===this.pendingSync)return o.resolve(!0);var i=null,s=null,u=this;return this.client.promiseOnConnection.then(function(){switch(s=t.length>0?t:e.length>0?e:n,i=s[0],i.type){case 0:return u.client.pull.apply(u.client,i.args);case 1:return u.client.push.apply(u.client,i.args);case 2:return u.client.search.apply(u.client,i.args);case 3:return u.client.createBranch.apply(u.client,i.args);case 7:return u.client.notify.apply(u.client,i.args);case 4:return u.client.chunkForFile.apply(u.client,i.args);case 5:return u.client.mergeChunksForFile.apply(u.client,i.args)}}).then(function(e){return r(null,e,i)}).catch(function(e){return r(e,null,i)}).then(function(i){return i&&s.shift(),u.run(e,t,n,r)})}},{key:"pull",value:function(e,t,n,r,i,o){var s="pull"+e+t+n+r+i+o;this.add(0,[].slice.call(arguments),s,this.normalPriority)}},{key:"push",value:function(e,t,n,r,i,o,s){var u="push"+t+n+r+o;this.add(1,[].slice.call(arguments),u,!0===s?this.highPriority:this.normalPriority)}},{key:"search",value:function(e,t,n,r,i,o,s,u,c,a,l,h){var f="search"+e+t+n;this.add(2,[].slice.call(arguments),f,this.normalPriority)}},{key:"createBranch",value:function(e,t,n,r){var i="createBranch"+e;this.add(3,[].slice.call(arguments),i,this.normalPriority)}},{key:"notify",value:function(e,t,n,r){var i="notify"+e+s.getId(t);this.add(7,[].slice.call(arguments),i,this.normalPriority)}},{key:"chunkForFile",value:function(e,t,n,r,i){var o="chunkForFile"+e+t+r+i;this.add(4,[].slice.call(arguments),o,this.lowPriority)}},{key:"mergeChunksForFile",value:function(e,t,n){var r="mergeChunksForFile"+e+t+n;this.add(5,[].slice.call(arguments),r,this.lowPriority)}}]),e}();e.exports=c},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(0),s=o.promisifyAll(n(39)),u=n(1),c=n(2),a=n(14),l=n(13),h=function e(t,n,i,o,s){r(this,e),this.name=t,this.emailOrId=n,this.passwordOrSecret=i,this.status=o,this.grants=s,this.retries=0,this.lastLoginTime=null,this.tokens={},this.refreshTokens={},this.groups=[]},f=function(){function e(t,n,i){r(this,e),this.db=t,this.notifications=n,this.debug=i}return i(e,null,[{key:"TOKENS_KEY",get:function(){return"tokens"}},{key:"REFRESH_TOKENS_KEY",get:function(){return"refreshTokens"}},{key:"STATUS_ACTIVE",get:function(){return"active"}},{key:"STATUS_INACTIVE",get:function(){return"inactive"}},{key:"GRANT_PASSWORD",get:function(){return"password"}},{key:"GRANT_CLIENT_CREDENTIALS",get:function(){return"client_credentials"}},{key:"USER_BRANCH",get:function(){return"Users"}}]),i(e,[{key:"getUserByEmailOrId",value:function(t,n,r,i){return this.prepareRepository(n).branches.checkout(e.USER_BRANCH).then(function(e){return null==r?e.findOne({emailOrId:t},i):e.findOne({$and:[{emailOrId:t},{status:r}]},i)})}},{key:"getUserByToken",value:function(t,n,r,i){return this.prepareRepository(n).branches.checkout(e.USER_BRANCH).then(function(n){var o={};if(void 0===r)if("LokiJs"===n.type)o[e.TOKENS_KEY]={$contains:t};else{var s=e.TOKENS_KEY+"."+t;o[s]={$exists:!0}}else if("LokiJs"===n.type)o={$and:[{},{status:r}]},o.$and[0][e.TOKENS_KEY]={$contains:t};else{var u=e.TOKENS_KEY+"."+t;o={$and:[{},{status:r}]},o.$and[0][u]={$exists:!0}}return n.findOne(o,i)})}},{key:"getUserByRefreshToken",value:function(t,n,r,i){return this.prepareRepository(n).branches.checkout(e.USER_BRANCH).then(function(n){var o={};if(void 0===r)if("LokiJs"===n.type)o[e.REFRESH_TOKENS_KEY]={$contains:t};else{var s=e.REFRESH_TOKENS_KEY+"."+t;o[s]={$exists:!0}}else if("LokiJs"===n.type)o={$and:[{},{status:r}]},o.$and[0][e.REFRESH_TOKENS_KEY]={$contains:t};else{var u=e.REFRESH_TOKENS_KEY+"."+t;o={$and:[{},{status:r}]},o.$and[0][u]={$exists:!0}}return n.findOne(o,i)})}},{key:"addUser",value:function(t,n,r,i,o,s){var u=this,a=null,l=null;return this.getUserByEmailOrId(n,o,e.STATUS_ACTIVE,["emailOrId"]).then(function(e){if(null!==e)throw new Error("User already exists with id "+n);return u.generatePasswordOrSecret(r)}).then(function(t){return l=t,a=u.prepareRepository(o),a.branches.checkout(e.USER_BRANCH)}).then(function(r){var u=new h(t,n,l,e.STATUS_ACTIVE,i);return c.init(u),c.setId(u,n),a.commit(r,u,s,o)})}},{key:"changeUserStatus",value:function(t,n,r,i){var o=this,s=null,u=null;return this.getUserByEmailOrId(t,r).then(function(n){if(null===(u=n))throw new Error("No such user with id "+t);return s=o.prepareRepository(r),s.branches.checkout(e.USER_BRANCH)}).then(function(e){return u.status=n,u.retries=0,s.commit(e,u,i,r)})}},{key:"updateUserToken",value:function(t,n,r,i,o,s,u,c){t.tokens[""+n]={clientId:i,expiry:r},null!=s&&(t.refreshTokens[""+s]={clientId:i,expiry:u});var a=this.prepareRepository(o);return a.branches.checkout(e.USER_BRANCH).then(function(e){return a.commit(e,t,c,o)})}},{key:"removeExpiredTokens",value:function(t,n,r){for(var i="",o=!1;void 0!==(i=u.findKey(t.tokens,function(e){return new Date(e.expiry)<new Date}));)o=!0,delete t.tokens[i];for(;void 0!==(i=u.findKey(t.refreshTokens,function(e){return new Date(e.expiry)<new Date}));)o=!0,delete t.refreshTokens[i];if(o){var s=this.prepareRepository(n);return s.branches.checkout(e.USER_BRANCH).then(function(e){return s.commit(e,t,r,n)})}return t}},{key:"revokeRefreshToken",value:function(t,n,r,i,s){var u=o.resolve(!1);if(t.refreshTokens[n]&&t.refreshTokens[n].clientId===r){delete t.refreshTokens[n];var c=this.prepareRepository(i);return c.branches.checkout(e.USER_BRANCH).then(function(e){return c.commit(e,t,s,i)}).then(function(){return!0})}return u}},{key:"verifyUserPasswordOrSecret",value:function(t,n,r,i,o){var u=this,c=null,a=null;return this.getUserByEmailOrId(t,i,e.STATUS_ACTIVE).then(function(e){if(null===(c=e)||c.grants.indexOf(r)<0)throw new Error("No user with id "+t+" is allowed to login with grantType "+r);return s.compareAsync(n,c.passwordOrSecret)}).then(function(t){return c.lastLoginTime=new Date,t?(c.retries=0,o="Successful login: "+o):(c.retries++,o="Failed login: "+o),a=u.prepareRepository(i),a.branches.checkout(e.USER_BRANCH)}).then(function(e){if(a.commit(e,c,o,i),0===c.retries)return c;throw new Error("Incorrect username or password")})}},{key:"changeUserPasswordOrSecret",value:function(t,n,r,i){var o=this,s=null,u=null;return this.getUserByEmailOrId(t,r).then(function(e){if(null===(s=e))throw new Error("No such user with id "+t);return o.generatePasswordOrSecret(n)}).then(function(t){return s.passwordOrSecret=t,s.retries=0,u=o.prepareRepository(r),u.branches.checkout(e.USER_BRANCH)}).then(function(e){return u.commit(e,s,i,r)})}},{key:"generatePasswordOrSecret",value:function(e){return s.genSaltAsync(10,10).then(function(t){return s.hashAsync(e,t)})}},{key:"prepareRepository",value:function(e){return new l(e,this.db,this.notifications,a,this.debug)}}]),e}();e.exports=f},function(e,t){e.exports=require("bcryptjs")}]);